---
description:
globs:
alwaysApply: false
---
# Regola: Usare sempre Spatie Model States per i campi di stato

## Regola
- Per ogni campo che rappresenta uno stato (es. user.state, order.status, moderation.state) usare sempre [spatie/laravel-model-states](https://github.com/spatie/laravel-model-states), **non** enum PHP native.
- Le enum PHP sono ammesse solo per tipi statici (es. UserType), **mai** per workflow, moderazione, pubblicazione, ecc.

## Motivazione
- Gestione delle transizioni tra stati (solo quelle consentite)
- Logica custom per ogni stato (side effect, permessi, validazione)
- Integrazione con Eloquent (cast automatico, query, observer)
- Eventi sulle transizioni
- Best practice per workflow e moderazione

## Esempio pratico
```php
// ERRATO
use Modules\<nome progetto>\Enums\UserState;
protected $casts = [ 'state' => UserState::class ];

// CORRETTO
use Modules\<nome progetto>\States\UserState;
protected $casts = [ 'state' => UserState::class ];

// State class
class UserState extends State { ... }
```

## Esempio di errore reale
```
Undefined array key "Modules\<nome progetto>\States\User\Pending"
```
- Stack trace: Spatie\ModelStates\StateCaster::get
- Tipico durante login o istanziazione User

## Checklist
- [ ] Nessun campo di stato usa enum PHP
- [ ] Tutti i campi di stato usano Spatie Model States
- [ ] Modelli, risorse, form, policy aggiornati
- [ ] Doc aggiornata

## Errori comuni
- Usare enum PHP per i campi di stato
- Dimenticare di configurare le transizioni
- Non aggiornare la doc

## Checklist di debug
- [ ] Nessun campo di stato usa enum PHP
- [ ] Tutte le classi di stato esistono e sono nel namespace corretto
- [ ] La mappatura degli stati Ã¨ completa
- [ ] I valori nel database corrispondono alle chiavi mappate
- [ ] Doc aggiornata

## Reminder
Se ricevi questo errore:
- Controlla che non stai usando enum PHP per i campi di stato
- Controlla la mappatura degli stati
- Controlla i namespace delle classi di stato
- Controlla i valori nel database

## Link doc
- [README <nome progetto>](../../laravel/Modules/<nome progetto>/docs/README.md)
- [README Xot](../../laravel/Modules/Xot/docs/README.md)
- [Spatie Model States](https://github.com/spatie/laravel-model-states)
