# Factory Critical Rules - SaluteOra

## Errore Gravissimo Identificato
**Data**: 2025-01-06
**Problema**: 35+ factory mancanti su 13 moduli
**Impatto**: Sistema testing compromesso

## Regole Assolute

### 1. Factory Obbligatoria per Ogni Model
- **SEMPRE** creare factory per ogni model
- **MAI** pushare model senza factory
- **BLOCCARE** PR senza factory

### 2. Validazione PHPStan Livello 9
- **SEMPRE** eseguire PHPStan per ogni factory
- **CORREGGERE** tutti gli errori prima del commit
- **TIPIZZAZIONE** rigorosa obbligatoria

### 3. Struttura Standard
```php
declare(strict_types=1);
namespace Modules\ModuleName\Database\Factories;
use Illuminate\Database\Eloquent\Factories\Factory;

/**
 * @extends Factory<ModelName>
 */
class ModelNameFactory extends Factory
{
    protected $model = ModelName::class;
    
    public function definition(): array
    {
        return [
            // Dati tipizzati correttamente
        ];
    }
}
```

### 4. Integrazione Model
```php
// Nel Model
use Illuminate\Database\Eloquent\Factories\HasFactory;

class ModelName extends BaseModel
{
    use HasFactory;
    // GetFactoryAction gestisce factory resolution
}
```

### 5. Tipizzazione Corretta
```php
// CORRETTO
/** @var string $value */
$value = (string) $this->faker->randomElement($array);
$formatted = sprintf('%s %s', $value1, (string) $value2);

// ERRATO
$value = $this->faker->randomElement($array);
$formatted = "{$value1} {$value2}";
```

## Situazione Corrente

### Completate (16/35+)
- User: 8/17 factory
- Geo: 4/8 factory  
- Media: 2/2 factory ✅
- Activity: 2/2 factory ✅

### Rimanenti
- User: 9 factory
- Geo: 4 factory
- Altri: 6 factory

## Prevenzione Assoluta

### NEVER AGAIN
- Model senza factory
- Factory senza validazione PHPStan
- Deploy senza factory complete
- Code review senza controllo factory

### ALWAYS DO  
- Factory per ogni model
- PHPStan livello 9 per ogni factory
- Documentazione aggiornata
- Test con tinker

## Collegamenti
- [Factory Audit Root](../../docs/factory-audit-2025.md)
- [User Factory Lessons](../../laravel/Modules/User/docs/factory-lessons-learned.md)
- [Factory Prevention Rules](../../docs/factory-prevention-rules.md)

---
**ERRORE GRAVISSIMO DA NON RIPETERE MAI PIÙ**
*Ultimo aggiornamento: 2025-01-06*